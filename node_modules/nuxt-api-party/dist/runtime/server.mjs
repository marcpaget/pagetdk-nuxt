import { createError, defineEventHandler, getRequestHeader, getRouterParam, readBody } from "h3";
import { deserializeMaybeEncodedBody } from "./utils.mjs";
import { useRuntimeConfig } from "#imports";
export default defineEventHandler(async (event) => {
  const endpointId = getRouterParam(event, "endpointId");
  const { apiParty } = useRuntimeConfig();
  const endpoints = apiParty.endpoints;
  const endpoint = endpoints[endpointId];
  if (!endpoint) {
    throw createError({
      statusCode: 404,
      statusMessage: `Unknown API endpoint "${endpointId}"`
    });
  }
  const _body = await readBody(event);
  const {
    path,
    query,
    headers,
    body,
    ...fetchOptions
  } = _body;
  const baseURL = new Headers(headers).get(`${endpointId}-endpoint-url`) || endpoint.url;
  try {
    return await $fetch(
      path,
      {
        ...fetchOptions,
        baseURL,
        query: {
          ...endpoint.query,
          ...query
        },
        headers: {
          ...endpoint.token && { Authorization: `Bearer ${endpoint.token}` },
          ...endpoint.cookies && { cookie: getRequestHeader(event, "cookie") },
          ...endpoint.headers,
          ...headers
        },
        ...body && { body: await deserializeMaybeEncodedBody(body) }
      }
    );
  } catch (err) {
    throw createError(err);
  }
});
